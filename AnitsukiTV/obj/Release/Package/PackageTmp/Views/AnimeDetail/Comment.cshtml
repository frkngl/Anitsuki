@using AnitsukiTV.Models
@model List<TBLANIMECOMMENT>

@if (Session["username"] != null)
{
    <div class="commentplace">
        <div class="headcomment">
            <div class="title">
                <i class="bi bi-pencil-square"></i> Düşüncelerinizi Yazın
            </div>
            <form id="comment-form" action="/AnimeDetail/LeaveComment" method="post" data-ajax="true" data-ajax-method="post" data-ajax-success="commentPosted">
                <textarea id="comment-text" name="COMMENT"></textarea>
                <input type="hidden" name="ANIMEID" value="@ViewBag.animeID" />
                <button type="submit"><i class="bi bi-send"></i> Yorum Yap</button>
            </form>
        </div>
    </div>
}
else
{
    <div style="display:flex; justify-content:center; margin-top:50px;">
        <p style="font-size:1.1rem;color:#ffffff;">Düşüncelerinizi yazmak için</p><a style="text-decoration: none;" href="/LoginSignIn/Login"><span style="color: #FF7F00; margin-left:5px; font-size:1.1rem;">Giriş Yapın</span></a>
    </div>
}
<div class="commentboxes">
    <div class="title">
        <div id="comment-count"> <i class="bi bi-chat"></i> @ViewBag.CommentCount Yorum</div>
    </div>
    <div id="comments" class="comments">
        @{ string isim = "abc";}
        @if (Model.Any())
        {
            foreach (var x in Model.Where(x => x.STATUS == true && x.USTID == null).OrderByDescending(x => x.ID).Take(100))
            {
                <div class="comment1">
                    @if (x.TBLUSER.PICTURE != null)
                    {
                        <img src="~/IMG/@x.TBLUSER.PICTURE">
                    }
                    else
                    {
                        <img src="~/IMG/stockuser.png" />
                    }

                    <div class="detail">
                        <div class="user">
                            <div class="name">
                                @x.TBLUSER.USERNAME
                            </div>
                            <div class="year">
                                @x.DATE.Value.ToString("dd.MM.yyyy")
                            </div>
                        </div>
                        <div class="text">
                            @x.COMMENT
                        </div>
                        <div class="more">
                            @{ isim = isim + x.ID;}
                            @if (User.Identity.IsAuthenticated)
                            {
                                <div class="reply" data-bs-toggle="modal" data-bs-target="#@isim">
                                    <i class="bi bi-reply"></i>Cevapla
                                </div>
                                <!-- Modal form here -->
                            }
                            else
                            {
                                <a href="/LoginSignIn/Login" style="text-decoration: none; color: white;">
                                    <i class="bi bi-reply"></i>Cevapla
                                </a>
                            }
                            <!-- Modal -->
                            <div style="margin-top: 100px;" class="modal fade" id="@isim" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div style="background-color: #000000; box-shadow: 0px 0px 20px #FF7F00" class="modal-content">
                                        <div class="modal-header">
                                            <h1 style="color:#ffffff;" class="modal-title fs-5" id="exampleModalLabel">Cevap Yazıyorsunuz</h1>
                                            <button style="background-color: #ffffff; color:#ffffff;" type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <form style="color:#ffffff;" action="/AnimeDetail/ReplyComment" method="post" class="form-group">
                                                <input hidden type="text" name="USTID" value="@x.ID" readonly class="form-control" style="border: none; color:#ffffff; outline: solid #000000; background-color: #313131; " />
                                                <input hidden type="text" name="ANIMEID" value="@ViewBag.anime" readonly class="form-control" style="border: none; color:#ffffff; outline: solid #000000; background-color: #313131; " />
                                                @if (x.TBLUSER.PICTURE != null)
                                                {
                                                    <img hidden src="~/IMG/@x.TBLUSER.PICTURE" alt="Profil Fotoğrafı" />
                                                }
                                                else
                                                {
                                                    <img hidden src="~/IMG/stockuser.png" />
                                                }
                                                <span hidden>@x.TBLUSER.USERNAME</span>
                                                Cevap yazdığınız kişi
                                                <input type="text" name="USERID" value="@x.TBLUSER.USERNAME" readonly class="form-control" style="border: none; color:#ffffff; outline: solid #000000; background-color: #313131; " />
                                                <br />
                                                Yorum
                                                <textarea name="COMMENT" class="form-control" style="border: none; color: #ffffff; background-color: #313131; outline: solid #000000; height: 200px;"></textarea>
                                                <br />
                                                <div style="width:100%; display:flex; justify-content:center;">
                                                    <button style="background-color: #FF7F00; width:90px; height:40px; border-radius:20px; border:none; font-size:1rem;" type="submit">Gönder</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="likeandunlike">
                                @{
                                    AnitsukiTVEntities db = new AnitsukiTVEntities();
                                    var userID = db.TBLUSER.Where(u => u.USERNAME == User.Identity.Name).Select(u => u.ID).FirstOrDefault();
                                    var likeExist = x.TBLANIMECOMMENTLIKE.Any(y => y.USERID == userID);
                                    var liked = x.TBLANIMECOMMENTLIKE.FirstOrDefault(y => y.USERID == userID)?.STATUS;
                                }

                                @if (User.Identity.IsAuthenticated)
                                {
                                    if (liked.HasValue && liked.Value)
                                    {
                                        <div class="like active" data-comment-id="@x.ID">
                                            <a style="text-decoration: none; cursor: pointer; color: white;" onclick="handleLikeOrUnlike(this, @x.ID, @userID, true)">
                                                <i style="margin-right:2px;" class="bi bi-hand-thumbs-up"></i>
                                                <span id="like-count-@x.ID">@x.TBLANIMECOMMENTLIKE.Where(y => y.STATUS == true).Count()</span>
                                            </a>
                                        </div>

                                        <div id="comment-success" style="display:none;"></div>
                                        <div id="comment-error" style="display:none;"></div>
                                        <span id="like-count-@x.ID">@x.TBLANIMECOMMENTLIKE.Where(y => y.STATUS == true).Count()</span>

                                        <div class="unlike" data-comment-id="@x.ID">
                                            <a style="text-decoration: none; cursor: pointer; color: white;" onclick="handleLikeOrUnlike(this, @x.ID, @userID, false)">
                                                <i style="margin-right:2px;" class="bi bi-hand-thumbs-down"></i>
                                                <span id="unlike-count-@x.ID">@x.TBLANIMECOMMENTLIKE.Where(y => y.STATUS == false).Count()</span>
                                            </a>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="like" style="margin-right:5px;" data-comment-id="@x.ID">
                                            <a style="text-decoration: none; cursor: pointer; color: white;" onclick="handleLikeOrUnlike(this, @x.ID, @userID, true)">
                                                <i style="margin-right:2px;" class="bi bi-hand-thumbs-up"></i>
                                                <span id="like-count-@x.ID">@x.TBLANIMECOMMENTLIKE.Where(y => y.STATUS == true).Count()</span>
                                            </a>
                                        </div>
                                        <div class="unlike active" data-comment-id="@x.ID">
                                            <a style="text-decoration: none; cursor: pointer; color: white;" onclick="handleLikeOrUnlike(this, @x.ID, @userID, false)">
                                                <i style="margin-right:2px;" class="bi bi-hand-thumbs-down"></i>
                                                <span id="unlike-count-@x.ID">@x.TBLANIMECOMMENTLIKE.Where(y => y.STATUS == false).Count()</span>
                                            </a>
                                        </div>
                                    }
                                }
                                else
                                {
                                    <div class="like" style="margin-right:5px;" data-comment-id="@x.ID">
                                        <a style="text-decoration:none; color:white;" href="/LoginSignIn/Login">
                                            <i style="margin-right:2px;" class="bi bi-hand-thumbs-up"></i>
                                            @x.TBLANIMECOMMENTLIKE.Where(y => y.STATUS == true).Count()
                                        </a>
                                    </div>
                                    <div class="unlike" data-comment-id="@x.ID">
                                        <a style="text-decoration:none; color:white;" href="/LoginSignIn/Login">
                                            <i style="margin-right:2px;" class="bi bi-hand-thumbs-down"></i>
                                            @x.TBLANIMECOMMENTLIKE.Where(y => y.STATUS == false).Count()
                                        </a>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>

                foreach (var y in Model.Where(y => y.STATUS == true && y.USTID == x.ID))
                {
                    <div class="comment2">
                        @if (y.TBLUSER.PICTURE != null)
                        {
                            <img src="~/IMG/@y.TBLUSER.PICTURE">
                        }
                        else
                        {
                            <img src="~/IMG/stockuser.png" />
                        }

                        <div class="detail">
                            <div class="user">
                                <div class="name">
                                    @y.TBLUSER.USERNAME
                                </div>
                                <div class="year">
                                    @y.DATE.Value.ToString("dd.MM.yyyy")
                                </div>
                            </div>
                            <div class="text">
                                @y.COMMENT
                            </div>
                            <div class="more">
                                @{ isim = isim + y.ID;}
                                @if (User.Identity.IsAuthenticated)
                                {
                                    <div class="reply" data-bs-toggle="modal" data-bs-target="#@isim">
                                        <i class="bi bi-reply"></i>Cevapla
                                    </div>
                                    <!-- Modal form here -->
                                }
                                else
                                {
                                    <a href="/LoginSignIn/Login" style="text-decoration: none; color: white;">
                                        <i class="bi bi-reply"></i>Cevapla
                                    </a>
                                }
                                <!-- Modal -->
                                <div style="margin-top: 100px;" class="modal fade" id="@isim" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div style="background-color: #000000; box-shadow: 0px 0px 20px #FF7F00" class="modal-content">
                                            <div class="modal-header">
                                                <h1 style="color:#ffffff;" class="modal-title fs-5" id="exampleModalLabel">Cevap Yazıyorsunuz</h1>
                                                <button style="background-color: #ffffff; color:#ffffff;" type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <form style="color:#ffffff;" action="/AnimeDetail/ReplyComment" method="post" class="form-group">
                                                    <input hidden type="text" name="USTID" value="@y.USTID" readonly class="form-control" style="border: none; color:#ffffff; outline: solid #000000; background-color: #313131; " />
                                                    <input hidden type="text" name="ANIMEID" value="@ViewBag.anime" readonly class="form-control" style="border: none; color:#ffffff; outline: solid #000000; background-color: #313131; " />
                                                    @if (y.TBLUSER.PICTURE != null)
                                                    {
                                                        <img hidden src="~/IMG/@y.TBLUSER.PICTURE" alt="Profil Fotoğrafı" />
                                                    }
                                                    else
                                                    {
                                                        <img hidden src="~/IMG/stockuser.png" />
                                                    }
                                                    <span hidden>@y.TBLUSER.USERNAME</span> 
                                                    Cevap yazdığınız kişi
                                                    <input type="text" name="USERID" value="@y.TBLUSER.USERNAME" readonly class="form-control" style="border: none; color:#ffffff; outline: solid #000000; background-color: #313131; " />
                                                    <br />
                                                    Yorum
                                                    <textarea name="COMMENT" class="form-control" style="border: none; color: #ffffff; background-color: #313131; outline: solid #000000; height: 200px;"></textarea>
                                                    <br />
                                                    <div style="width:100%; display:flex; justify-content:center;">
                                                        <button style="background-color: #FF7F00; width:90px; height:40px; border-radius:20px; border:none; font-size:1rem;" type="submit">Gönder</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="likeandunlike">
                                    @{
                                        var likedReply = y.TBLANIMECOMMENTLIKE.FirstOrDefault(z => z.USERID == userID)?.STATUS;
                                    }

                                    @if (User.Identity.IsAuthenticated)
                                    {
                                        if (likedReply.HasValue && likedReply.Value)
                                        {
                                            <div class="like active" data-comment-id="@y.ID">
                                                <a style="text-decoration:none; cursor:pointer; color:white;" onclick="handleLikeOrUnlike(this, @y.ID, @userID, true)">
                                                    <i style="margin-right:2px;" class="bi bi-hand-thumbs-up"></i>
                                                    <span id="like-count-@y.ID">@y.TBLANIMECOMMENTLIKE.Where(z => z.STATUS == true).Count()</span>
                                                </a>
                                            </div>
                                            <div class="unlike" data-comment-id="@y.ID">
                                                <a style="text-decoration: none; cursor: pointer; color: white; " onclick="handleLikeOrUnlike(this, @y.ID, @userID, false)">
                                                    <i style="margin-right:2px;" class="bi bi-hand-thumbs-down"></i>
                                                    <span id="unlike-count-@y.ID">@y.TBLANIMECOMMENTLIKE.Where(z => z.STATUS == false).Count()</span>
                                                </a>
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="like" style="margin-right:5px;" data-comment-id="@y.ID">
                                                <a style="text-decoration: none; cursor: pointer; color: white; " onclick="handleLikeOrUnlike(this, @y.ID, @userID, true)">
                                                    <i style="margin-right:2px;" class="bi bi-hand-thumbs-up"></i>
                                                    <span id="like-count-@y.ID">@y.TBLANIMECOMMENTLIKE.Where(z => z.STATUS == true).Count()</span>
                                                </a>
                                            </div>
                                            <div class="unlike active" data-comment-id="@y.ID">
                                                <a style="text-decoration: none; cursor: pointer; color: white; " onclick="handleLikeOrUnlike(this, @y.ID, @userID, false)">
                                                    <i style="margin-right:2px;" class="bi bi-hand-thumbs-down"></i>
                                                    <span id="unlike-count-@y.ID">@y.TBLANIMECOMMENTLIKE.Where(z => z.STATUS == false).Count()</span>
                                                </a>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <div class="like" style="margin-right:5px;" data-comment-id="@y.ID">
                                            <a style="text-decoration: none; cursor: pointer; color: white; " href="/LoginSignIn/Login">
                                                <i style="margin-right:2px;" class="bi bi-hand-thumbs-up"></i>
                                                @y.TBLANIMECOMMENTLIKE.Where(z => z.STATUS == true).Count()
                                            </a>
                                        </div>
                                        <div class="unlike" data-comment-id="@y.ID">
                                            <a style="text-decoration: none; cursor: pointer; color: white; " href="/LoginSignIn/Login">
                                                <i style="margin-right:2px;" class="bi bi-hand-thumbs-down"></i>
                                                @y.TBLANIMECOMMENTLIKE.Where(z => z.STATUS == false).Count()
                                            </a>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                }
            }
        }
        else
        {
            <div style="width:100%; height:auto; display:flex; justify-content:center;">Bu animeye henüz yorum yapılmamış.</div>
        }
    </div>
</div>





<script src="~/Scripts/jquery-3.7.1.min.js"></script>
<script>
    $('#comment-form').submit(function (e) {
    e.preventDefault();
    var formData = $(this).serialize();
    $.ajax({
        type: 'POST',
        url: '@Url.Action("LeaveComment")',
        data: formData,
        success: function (data) {
            if (data.success) {
                var commentHtml = '<div class="comment1">' +
                    '<img src="' + (data.picture || '/IMG/stockuser.png') + '">' +
                    '<div class="detail">' +
                        '<div class="user">' +
                            '<div class="name">' + data.username + '</div>' +
                            '<div class="year">' + data.date + '</div>' +
                        '</div>' +
                        '<div class="text">' + data.commentText + '</div>' +
                        '<div class="more">' +
                            '<div class="reply"><i class="bi bi-reply"></i>Cevapla</div>' +
                            '<div class="likeandunlike">' +
                                '<div class="like"><i class="bi bi-hand-thumbs-up"></i>0</div>' +
                                '<div class="unlike"><i class="bi bi-hand-thumbs-down"></i>0</div>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                '</div>';
                // Yorumu sayfaya ekleyin
                $('#comments').prepend(commentHtml);
                // Yorum alanını temizle
                $('#comment-text').val('');
                // Yorum sayısını güncelle
                var commentCount = parseInt($('#comment-count').text().replace(/ Yorum$/, '')) + 1;
                $('#comment-count').html('<i class="bi bi-chat"></i> ' + commentCount + ' Yorum');
            } else {
                // Hata mesajını göster
                $('#comment-error').text(data.message).fadeIn().delay(2000).fadeOut();
            }
        }
    });
    return false;
});
</script>

<script>
    function handleLikeOrUnlike(element, commentId, userId, isLike) {
        var likeButton, unlikeButton, likeCountSpan, unlikeCountSpan;

        if (isLike) {
            likeButton = $(element);
            unlikeButton = likeButton.parent().siblings(".unlike").find("a");
            likeCountSpan = likeButton.find("span");
            unlikeCountSpan = unlikeButton.find("span");
        } else {
            unlikeButton = $(element);
            likeButton = unlikeButton.parent().siblings(".like").find("a");
            unlikeCountSpan = unlikeButton.find("span");
            likeCountSpan = likeButton.find("span");
        }

        $.ajax({
            type: "POST",
            url: "/AnimeDetail/LikeOrUnlikeComment",
            data: { id: commentId, userId: userId, isLike: isLike },
            success: function (data) {
                likeCountSpan.text(data.likeCount);
                unlikeCountSpan.text(data.unlikeCount);
                if (isLike) {
                    if (data.likeCount > 0) {
                        likeButton.addClass("active");
                        unlikeButton.removeClass("active");
                    } else {
                        likeButton.removeClass("active");
                        unlikeButton.addClass("active");
                    }
                } else {
                    if (data.unlikeCount > 0) {
                        unlikeButton.addClass("active");
                        likeButton.removeClass("active");
                    } else {
                        unlikeButton.removeClass("active");
                        likeButton.addClass("active");
                    }
                }
            }
        });
    }
</script>

